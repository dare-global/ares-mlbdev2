// ////////////////////////////////////////////////////////////////////////////
// ////////////////////////////////////////////////////////////////////////////
// MLB NatsWrapper Library Module File
// ////////////////////////////////////////////////////////////////////////////
/*
   File Name         :  NatsMsg.cpp

   File Description  :  Implementation of the NatsMsg class.

   Revision History  :  2024-08-17 --- Creation.
                           Michael L. Brock

      Copyright Michael L. Brock 2024.
      Distributed under the Boost Software License, Version 1.0.
      (See accompanying file LICENSE_1_0.txt or copy at
      http://www.boost.org/LICENSE_1_0.txt)

*/
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
// ////////////////////////////////////////////////////////////////////////////
// Required include files...
// ////////////////////////////////////////////////////////////////////////////

#include <NatsWrapper/NatsMsg.hpp>

// ////////////////////////////////////////////////////////////////////////////

namespace MLB {

namespace NatsWrapper {

// ////////////////////////////////////////////////////////////////////////////
// PRIVATE: Accessible to NatsSubscription::NextMessage()
NatsMsg::NatsMsg(natsMsg *nats_msg)
	:nats_msg_sptr_()
{
	if (nats_msg)
		nats_msg_sptr_.reset(nats_msg, ::natsMsg_Destroy);
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
NatsMsg::NatsMsg(NatsSubscription &nats_subs, int64_t time_out)
	:nats_msg_sptr_()
{
	natsMsg *nats_msg = NULL;

	NatsWrapper_THROW_IF_NOT_OK(::natsSubscription_NextMsg,
		(&nats_msg, nats_subs.GetPtr(), time_out))

	nats_msg_sptr_.reset(nats_msg, ::natsMsg_Destroy);
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
NatsMsg NatsMsg::Create(const char *subject, const void *data_ptr,
	std::size_t data_length, const char *reply)
{
	natsMsg *nats_msg = NULL;

	NatsWrapper_THROW_IF_NOT_OK(::natsMsg_Create,
		(&nats_msg, subject, reply,
		 static_cast<const char *>(data_ptr),
		 static_cast<int>(data_length)))

	return NatsMsg(nats_msg);
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
NatsMsg NatsMsg::Create(const std::string &subject, const std::string &data,
	const std::string &reply)
{
	return Create(subject.c_str(), data.data(), data.size(),
		reply.empty() ? nullptr : reply.c_str());
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
NatsMsg::~NatsMsg()
{
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
const char *NatsMsg::GetSubject() const
{
	return(natsMsg_GetSubject(GetPtrChecked()));
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
const char *NatsMsg::GetReply() const
{
	return(natsMsg_GetReply(GetPtrChecked()));
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
const char *NatsMsg::GetData() const
{
	return(natsMsg_GetData(GetPtrChecked()));
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
int NatsMsg::GetDataLength() const
{
	return(natsMsg_GetDataLength(GetPtrChecked()));
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
bool NatsMsg::IsNoResponders() const
{
	GetPtrChecked();

	return(::natsMsg_IsNoResponders(nats_msg_sptr_.get()));
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
void NatsMsg::SetHeader(const char *key, const char *value)
{
	NatsWrapper_THROW_IF_NOT_OK(::natsMsgHeader_Set,
		(GetPtrChecked(), key, value))
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
void NatsMsg::SetHeader(const std::string &key, const std::string &value)
{
	SetHeader(key.c_str(), value.c_str());
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
void NatsMsg::AddHeader(const char *key, const char *value)
{
	NatsWrapper_THROW_IF_NOT_OK(::natsMsgHeader_Add,
		(GetPtrChecked(), key, value))
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
void NatsMsg::AddHeader(const std::string &key, const std::string &value)
{
	AddHeader(key.c_str(), value.c_str());
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
std::string NatsMsg::GetHeader(const char *key) const
{
	GetPtrChecked();

	const char *value = nullptr;
	natsStatus  s     = ::natsMsgHeader_Get(nats_msg_sptr_.get(), key, &value);

	if (s == NATS_NOT_FOUND)
		return std::string();

	if (s != NATS_OK)
		throw NatsExceptionStatus(s, "natsMsgHeader_Get");

	return std::string(value ? value : "");
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
std::string NatsMsg::GetHeader(const std::string &key) const
{
	return GetHeader(key.c_str());
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
bool NatsMsg::HasHeader(const char *key) const
{
	GetPtrChecked();

	const char *value = nullptr;
	natsStatus  s     = ::natsMsgHeader_Get(nats_msg_sptr_.get(), key, &value);

	if (s == NATS_NOT_FOUND)
		return false;

	if (s != NATS_OK)
		throw NatsExceptionStatus(s, "natsMsgHeader_Get");

	return true;
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
bool NatsMsg::HasHeader(const std::string &key) const
{
	return HasHeader(key.c_str());
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
void NatsMsg::DeleteHeader(const char *key)
{
	NatsWrapper_THROW_IF_NOT_OK(::natsMsgHeader_Delete,
		(GetPtrChecked(), key))
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
void NatsMsg::DeleteHeader(const std::string &key)
{
	DeleteHeader(key.c_str());
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
natsMsg *NatsMsg::GetPtr()
{
	return(nats_msg_sptr_.get());
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
const natsMsg *NatsMsg::GetPtr() const
{
	return(nats_msg_sptr_.get());
}
// ////////////////////////////////////////////////////////////////////////////

namespace {

// ////////////////////////////////////////////////////////////////////////////
const natsMsg *GetPtrChecked_Helper(const natsMsg *nats_msg_ptr)
{
	if (!nats_msg_ptr)
		throw std::runtime_error("Attempt to make use of the underlying NATS "
			"message pointer, but it is NULL.");

	return(nats_msg_ptr);
}
// ////////////////////////////////////////////////////////////////////////////

} // Anonymous namespace

// ////////////////////////////////////////////////////////////////////////////
natsMsg *NatsMsg::GetPtrChecked()
{
	return(const_cast<natsMsg *>(GetPtrChecked_Helper(nats_msg_sptr_.get())));
}
// ////////////////////////////////////////////////////////////////////////////

// ////////////////////////////////////////////////////////////////////////////
const natsMsg *NatsMsg::GetPtrChecked() const
{
	return(GetPtrChecked_Helper(nats_msg_sptr_.get()));
}
// ////////////////////////////////////////////////////////////////////////////

} // namespace NatsWrapper

} // namespace MLB

